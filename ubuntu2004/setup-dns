# Install dnsmasq before disabling systemd-resolved
sudo apt-get install -qq dnsmasq

# Disable systemd-resolve
sudo systemctl stop systemd-resolved.service
sudo systemctl disable systemd-resolved.service

# Kill listener on 127.0.0.53:53
for pid in $(ps -C systemd-resolve -o pid=); do
    sudo kill -9 $pid &> /dev/null
done;

# Remove symlink resolv.conf to systemd-resolved configuration file.
sudo rm -f /etc/resolv.conf &> /dev/null

# Create new resolv.conf and make it immutable.
echo "nameserver 127.0.0.1" | sudo tee /etc/resolv.conf
chattr +i /etc/resolv.conf

# Make dnsmasq main local DNS forwarder and cache server
sudo systemctl start dnsmasq
sudo systemctl enable dnsmasq
